<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/pages/masque-layout.html">
<link rel="import" href="/bower_components/o-auth/o-auth.html">
<link rel="import"  href="/bower_components/paper-elements/paper-elements.html">
<link rel="import" href="/bower_components/file-input/file-input.html">


<polymer-element name="masque-party" noscript>
    <template >

        <style>

            .default {
                background: #673ab7;
                color: #ede7f6;
            }

            .submit {
                background: #311b92;
                color: #ede7f6;
            }

        </style>
        <core-overlay opened="true" layout vertical>
            <paper-shadow z="1">
                <div class="sigin-container">
                    <paper-input floatingLabel label="#partyName"></paper-input>
                    <a href="/auth/twitter"><paper-button align="center" width="100%">Join Party<core-icon icon="post-twitter"></core-icon></paper-button></a>
                    <a href="/auth/twitter"><paper-button align="center" width="100%">Create Party</paper-button></a>
                </div>
            </paper-shadow>
        </core-overlay>
        <masque-layout>
            <section  horizontal layout start core-light-theme>
                <div vertical>
                    <core-animated-pages>
                        <img src="http://placehold.it/400x400">
                    </core-animated-pages>
                    <div horizontal layout center-justified style="width:50%;" >
                        <div horizontal layout center-justified>
                            <div flex></div>
                            <paper-icon-button src="/img/0.png" onclick="vote(0)"></paper-icon-button>
                            <paper-icon-button src="/img/1.png" onclick="vote(1)"></paper-icon-button>
                            <paper-icon-button src="/img/2.png" onclick="vote(2)"></paper-icon-button>
                            <paper-icon-button src="/img/3.png" onclick="vote(3)"></paper-icon-button>
                            <paper-icon-button src="/img/4.png" onclick="vote(4)"></paper-icon-button>
                            <div flex></div>
                        </div>
                    </div>
                    <input type="file" id="">
                    <paper-button label="upload" onclick="s3_upload()"></paper-button>
                </div>
            </section>
        </masque-layout>

        <script>
            $scope.onFileSelect = function ($files) {
                var activeUser = $scope.activeUser;
                $scope.files = $files;
                $scope.upload = [];
                if(!activeUser.mongoId){console.log('activeUser is: '+JSON.stringify(activeUser))}
                if (activeUser && activeUser.mongoId){
                    for (var i = 0; i < $files.length; i++) {
                        var file = $files[i];
                        file.progress = parseInt(0);

                        (function (file, i) {

                            $.ajax('/aws/s3Policy?mimeType=' + file.type).success(function (response) {
                                var s3Params = response;

                                $scope.upload[i] = $upload.upload({
                                    url: 'https://' + 'layers-store' + '.s3.amazonaws.com/',
                                    method: 'POST',
                                    data: {
                                        'key': 'images/' + activeUser.mongoId + '/' + Math.round(Math.random() * 10000) + '$$' + file.name,
                                        'acl': 'public-read',
                                        'Content-Type': file.type,
                                        'AWSAccessKeyId': s3Params.AWSAccessKeyId,
                                        'success_action_status': '201',
                                        'Policy': s3Params.s3Policy,
                                        'Signature': s3Params.s3Signature
                                    },
                                    file: file,
                                });
                                $scope.upload[i]
                                    .then(function (response) {
                                        file.progress = parseInt(100);
                                        if (response.status === 201) {
                                            var data = xml2json.parser(response.data),
                                                parsedData;
                                            parsedData = {
                                                location: data.postresponse.location,
                                                bucket: data.postresponse.bucket,
                                                key: data.postresponse.key,
                                                etag: data.postresponse.etag
                                            };
                                            $scope.imageUploads.push(parsedData);
                                            var image = parsedData.location;
                                            $rootScope.addImage(image,1,1);
                                        } else {
                                            alert('Upload Failed');
                                        }
                                    }, null, function (evt) {
                                        file.progress = parseInt(100.0 * evt.loaded / evt.total);
                                    });

                            });
                        }(file, i));

                    }
            if(typeof(user.screen_name)==="string"){

            }
            if(window.location.search){
                var q = window.location.search;
                console.log(q,"<--query")
                $.ajax("/auth/twitter/callback"+q,{
                    success:function(data){
                        user=data;
                        console.log(user);
                    }
                })
            }else{

            }
        </script>
    </template>
</polymer-element>
